<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Medical Store - Surat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.3s ease-out; }
        .btn-glow { transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(13, 148, 136, 0.3); }
        .btn-glow:hover { box-shadow: 0 6px 25px 0 rgba(13, 148, 136, 0.4); transform: translateY(-2px); }
        .card-hover-effect { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .card-hover-effect:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -5px rgb(0 0 0 / 0.08); border-color: #0d9488; }
        .mobile-menu { transition: transform 0.3s ease-in-out; }
        
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .shimmer-bg { position: relative; overflow: hidden; background-color: #e5e7eb; }
        .shimmer-bg::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, #e5e7eb 0, #f3f4f6 20%, #f3f4f6 60%, #e5e7eb 100%); animation: shimmer 1.5s infinite; content: ''; }
        
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee { animation: marquee 40s linear infinite; }
        .animate-marquee:hover { animation-play-state: paused; }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(8px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .trending-text { animation: fadeInOut 3s ease-in-out infinite; }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-white/90 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="#" class="flex items-center gap-2">
                    <i class="fa-solid fa-heart-pulse text-2xl text-teal-600"></i>
                    <span class="font-bold text-xl text-teal-800">Lucky Medical Store</span>
                </a>
                <div class="hidden lg:flex items-center space-x-8">
                    <a href="#home" class="text-gray-600 hover:text-teal-600 font-medium">Home</a>
                    <a href="#medicines-section" class="text-gray-600 hover:text-teal-600 font-medium">Products</a>
                    <button id="spin-win-nav-btn" class="text-gray-600 hover:text-teal-600 font-medium"><i class="fa-solid fa-star mr-1"></i>Spin & Win</button>
                    <div id="auth-buttons-desktop" class="flex items-center gap-4"></div>
                </div>
                <div class="lg:hidden">
                    <button id="hamburger-btn" class="text-gray-700 focus:outline-none"><i class="fa-solid fa-bars fa-xl"></i></button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="lg:hidden hidden mobile-menu bg-white border-t border-gray-200">
            <a href="#home" class="block py-3 px-4 text-gray-600 hover:bg-teal-50">Home</a>
            <a href="#medicines-section" class="block py-3 px-4 text-gray-600 hover:bg-teal-50">Products</a>
            <button id="spin-win-mobile-btn" class="w-full text-left block py-3 px-4 text-gray-600 hover:bg-teal-50"><i class="fa-solid fa-star mr-1"></i>Spin & Win</button>
            <div id="auth-buttons-mobile" class="px-4 py-2"></div>
        </div>
    </nav>

    <header id="home" class="relative bg-gray-800">
        <div class="absolute inset-0">
            <img src="https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover opacity-20" alt="Pharmacy Background">
        </div>
        <div class="relative container mx-auto px-4 py-16 md:py-24 text-center text-white">
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">Lucky Medical Store</h1>
            <p class="text-teal-200 mt-6 text-lg max-w-2xl mx-auto">Your trusted pharmacy in Surat. Fast, reliable, and right at your doorstep.</p>
            <div class="mt-10 flex justify-center gap-4 flex-wrap">
                   <button id="hero-order-now-btn" class="inline-block bg-teal-500 text-white font-bold py-3 px-8 rounded-full hover:bg-teal-600 transition duration-300 transform hover:scale-105 shadow-lg"><i class="fa-solid fa-pills mr-2"></i>Order Now</button>
                   <a href="#medicines-section" class="inline-block bg-white/20 backdrop-blur-sm text-white font-bold py-3 px-8 rounded-full hover:bg-white/30 transition duration-300">Browse Products</a>
            </div>
        </div>
    </header>


    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <section id="medicines-section" class="my-16">
            <div class="text-center mb-10"><h2 class="text-3xl font-bold text-gray-800">Find Your Medicines</h2><p class="text-gray-500 mt-1">Search for a product or explore our top picks below.</p><div class="max-w-xl mx-auto mt-6"><div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-4"><i class="fa-solid fa-magnifying-glass text-gray-400"></i></span><input type="text" id="search-bar" placeholder="e.g. 'Dolo 650' or 'Cough Syrup'" class="w-full p-4 pl-12 border border-gray-300 rounded-full focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></div></div></div>
            
            <div id="initial-prompt" class="max-w-6xl mx-auto hidden">
                    <h3 class="text-2xl font-bold text-gray-800 text-center mb-6">Top Picks For You</h3>
                    <div class="w-full overflow-hidden group"><div id="scrolling-banners" class="flex animate-marquee group-hover:paused"></div></div>
                    <div class="text-center bg-white p-4 rounded-lg shadow-sm border mt-8">
                        <span class="font-semibold text-gray-600 mr-2">Users Also Search:</span>
                        <span class="inline-block text-teal-600 font-bold text-lg"><span id="trending-text" class="trending-text"></span></span>
                    </div>
            </div>

            <div id="shimmer-container" class="max-w-6xl mx-auto"></div>
            <div id="medicine-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
            <p id="no-results" class="text-center text-gray-500 mt-8 hidden">No medicines found matching your search.</p>
        </section>

        <section id="booking-section" class="my-16 max-w-2xl mx-auto bg-white p-8 md:p-10 rounded-2xl shadow-xl border border-gray-100">
            <h2 class="text-3xl font-bold mb-6 text-center">Place Your Order</h2>
            <form id="booking-form" action="https://formspree.io/f/mjkrrbnb" method="POST" class="space-y-6">
                    <div><label for="medicine-select" class="block text-sm font-medium text-gray-700 mb-1">Selected Medicine</label><select id="medicine-select" name="Medicine" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" disabled><option value="">-- Search and select a product --</option></select></div>
                
                <div id="price-section" class="bg-gray-50 p-4 rounded-lg hidden">
                    <div class="flex justify-between items-center text-gray-700"><span>Price:</span><span id="price-display"></span></div>
                    <div id="discount-row" class="flex justify-between items-center text-green-600 font-semibold hidden"><span>Discount:</span><span id="discount-display"></span></div>
                    <hr class="my-2 border-t border-gray-200">
                    <div class="flex justify-between items-center font-bold text-lg"><span>Total:</span><span id="total-display"></span></div>
                </div>

                    <div>
                        <a href="#" id="show-coupon-btn" class="text-sm font-semibold text-teal-600 hover:underline">Have a coupon code?</a>
                        <div id="coupon-section" class="flex gap-2 mt-2 hidden">
                            <input type="text" id="coupon-input" placeholder="Enter code" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <button type="button" id="apply-coupon-btn" class="bg-gray-700 text-white font-bold px-5 rounded-lg hover:bg-gray-800">Apply</button>
                        </div>
                        <p id="coupon-status" class="text-sm mt-1"></p>
                    </div>
                    
                <div><label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="name" name="Customer Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="e.g., Aditya Saroj"></div>
                <div><label for="whatsapp" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number</label><input type="tel" id="whatsapp" name="WhatsApp Number" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="e.g., 9876543210"></div>
                <div><label for="address" class="block text-sm font-medium text-gray-700 mb-1">Full Delivery Address</label><textarea id="address" name="Delivery Address" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="B-11 SAI DARSHAN RESIDENCY..."></textarea></div>
                
                <input type="hidden" id="location-coords" name="GPS Location">
                <div>
                    <button type="button" id="get-location-btn" class="w-full flex items-center justify-center gap-3 p-3 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition text-gray-600 font-semibold">
                        <i class="fa-solid fa-location-crosshairs text-teal-500"></i> Get My Current Location
                    </button>
                    <p id="location-status" class="text-sm text-center mt-2 text-gray-500">Location must be provided to place an order.</p>
                </div>
                
                <div class="pt-4"><button type="submit" class="w-full bg-teal-600 text-white font-bold py-4 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 flex items-center justify-center gap-3 btn-glow" id="place-order-btn" disabled><i class="fa-regular fa-paper-plane"></i> Confirm & Place Order</button></div>
                    <input type="hidden" name="Original Price" id="hidden-original-price">
                    <input type="hidden" name="Discount Applied" id="hidden-discount-applied">
                    <input type="hidden" name="Final Price" id="hidden-final-price">
            </form>
        </section>
    </main>
    
    <footer class="bg-gray-800 text-white mt-20">
        <div class="container mx-auto py-10 px-4 text-center"><p class="font-bold text-lg">Lucky Medical Store</p><p class="text-gray-400 mt-2">B-11 SAI DRASHAN RESIDENCY, OPP. UMA PLAZA, KHARWASA ROAD, DINDOLI, SURAT</p><p class="text-gray-400 mt-2">For inquiries, email: <a href="mailto:radhanasaroj7@gmail.com" class="text-teal-400 hover:underline">luckymedicalstore@gmail.com</a></p><div class="mt-4 text-gray-500 text-sm">© <span id="year"></span> Lucky Medical Store . All Rights Reserved.</div></div>
    </footer>
    
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-enter z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center"><div id="modal-icon" class="mb-4"></div><h3 id="modal-title" class="text-xl font-bold mb-3"></h3><p id="modal-message" class="text-gray-600 mb-6 whitespace-pre-line"></p><button id="modal-close" class="w-full bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition">OK</button></div>
    </div>
    <div id="promo-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden modal-enter z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full relative overflow-hidden">
            <button id="promo-close-btn" class="absolute top-4 right-4 text-gray-600 bg-white/50 hover:bg-white/80 rounded-full w-8 h-8 flex items-center justify-center transition z-20"><i class="fa-solid fa-times"></i></button>
            <div class="grid md:grid-cols-2 items-center">
                <div class="p-8"><h3 class="font-extrabold text-2xl text-teal-600">Welcome!</h3><p class="mt-2 text-gray-600">Get <span class="font-bold text-teal-700">15% OFF</span> your first order. Use code <span class="font-bold bg-teal-100 text-teal-800 px-2 py-1 rounded">LUCKY15</span>.</p><a href="#booking-section" id="promo-shop-now" class="mt-6 inline-block w-full text-center bg-teal-600 text-white font-bold py-3 px-6 rounded-lg btn-glow">Shop Now</a></div>
                <div class="hidden md:block h-full"><img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover" alt="Doctor"></div>
            </div>
        </div>
    </div>
    
    <div id="spin-win-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden modal-enter z-50">
        <div class="bg-gradient-to-br from-teal-50 to-cyan-100 p-8 rounded-2xl shadow-xl max-w-md w-full text-center relative">
               <button id="spin-win-close-btn" class="absolute top-4 right-4 text-gray-600 bg-white/50 hover:bg-white/80 rounded-full w-8 h-8 flex items-center justify-center transition z-20"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-3xl font-bold text-teal-800">Spin & Win!</h2>
            <p class="text-gray-600 mt-2 mb-6">Spin the wheel to win an exciting discount coupon!</p>
            <div class="relative w-64 h-64 mx-auto mb-6">
                <div id="spin-wheel" class="w-full h-full rounded-full border-8 border-white shadow-lg" style="transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full border-4 border-teal-500 shadow-md flex items-center justify-center"><i class="fa-solid fa-star text-teal-500 text-xl"></i></div>
                <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-0 h-0 border-x-8 border-x-transparent border-b-[16px] border-b-teal-600"></div>
            </div>
            <button id="spin-btn" class="w-full bg-teal-600 text-white font-bold py-4 rounded-lg btn-glow text-lg disabled:bg-gray-400 disabled:shadow-none disabled:cursor-not-allowed">Spin Now</button>
            <p id="spin-result" class="mt-4 font-semibold text-lg text-gray-700 h-6"></p>
        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden modal-enter z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full relative">
               <button id="auth-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition"><i class="fa-solid fa-times fa-lg"></i></button>
               <div class="p-8">
                 <div class="flex border-b border-gray-200 mb-6">
                    <button id="login-tab-btn" class="w-1/2 py-4 text-center font-semibold text-teal-600 border-b-2 border-teal-600">Login</button>
                    <button id="signup-tab-btn" class="w-1/2 py-4 text-center font-semibold text-gray-500">Sign Up</button>
                </div>

                <form id="login-form" class="space-y-4">
                    <div><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <p id="login-error" class="text-red-500 text-sm h-4"></p>
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg btn-glow">Login</button>
                    <button id="forgot-password-link" type="button" class="w-full text-center text-sm text-teal-600 hover:underline mt-2">Forgot Password?</button>
                </form>

                <form id="signup-form" class="space-y-4 hidden">
                    <div><label for="signup-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="signup-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <p id="signup-error" class="text-red-500 text-sm h-4"></p>
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg btn-glow">Create Account</button>
                </form>

                <div id="otp-verification-section" class="space-y-4 hidden">
                    <p class="text-gray-600 text-center">An OTP has been sent to your email. Please enter it below to verify your account.</p>
                    <div>
                        <label for="otp-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="otp-email" required class="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                    </div>
                    <div>
                        <label for="otp-input" class="block text-sm font-medium text-gray-700">OTP</label>
                        <input type="text" id="otp-input" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter 6-digit OTP">
                    </div>
                    <p id="otp-error" class="text-red-500 text-sm h-4"></p>
                    <button type="button" id="verify-otp-btn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg btn-glow">Verify OTP</button>
                    <button type="button" id="resend-otp-btn" class="w-full text-center text-sm text-teal-600 hover:underline mt-2">Resend OTP</button>
                </div>

                <div id="reset-password-section" class="space-y-4 hidden">
                    <h3 class="text-xl font-bold text-center mb-4">Reset Your Password</h3>
                    <div>
                        <label for="reset-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="reset-email" required class="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                    </div>
                    <div>
                        <label for="reset-token-input" class="block text-sm font-medium text-gray-700">Reset Token</label>
                        <input type="text" id="reset-token-input" required class="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                    </div>
                    <div>
                        <label for="new-password-input" class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" id="new-password-input" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></div>
                    <p id="reset-password-error" class="text-red-500 text-sm h-4"></p>
                    <button type="button" id="submit-reset-password-btn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg btn-glow">Reset Password</button>
                </div>
               </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        
        // --- IMPORTANT: CONFIGURE THESE ---
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-MH4nLsEaIH3oXpTKKI1LEYsOpzP2MXMgtKkdfnKPM8OBuEZEExSwpJGQc9BAM5Xl3w6uDTjWh-oU/pub?gid=0&single=true&output=csv';
        // PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL HERE
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyLXLf8TvyxrOSE9Qd_mNvzr54RRo4TtOLzpjvTKToZjpQ9k82ZAqlF7wHTgG5fK9Puiw/exec'; 
        const COUPON_CODE = 'LUCKY15'; // This is for the static promo modal, not dynamic spin coupons
        
        // Store location (Lucky Medical Store) coordinates - Dindoli, Surat
        const STORE_LATITUDE = 21.143466; 
        const STORE_LONGITUDE = 72.881634; 
        const SERVICE_RADIUS_METERS = 2000; // 2 kilometers

        let userLatitude = null;
        let userLongitude = null;
        let isLocationAccepted = false; // Flag to track if location is accepted and within range

        const featuredProducts = [
            { name: "D-Fresh", image: "https://gargagencypharma.com/wp-content/uploads/2024/09/63.-D-FRESH-MR-TAB-10TAB-600x500-1.jpg", bgColor: "from-teal-600 to-teal-800" },
            { name: "Revital H", image: "https://cdn01.pharmeasy.in/dam/products_otc/270551/revital-h-men-multivitamin-with-zinc-ginseng-for-immunity-strong-bones-energy-10-capsules-6.1-1729854670.jpg", bgColor: "from-indigo-700 to-indigo-900" },
            { name: "Doliprane", image: "https://moncoinsante.com/mcs/65586-large_default/dolipranetabs-1000mg-adults-pain-fever-sanofi-8-coated-tablets.jpg", bgColor: "from-rose-700 to-rose-900" },
            { name: "Volini", image: "https://m.media-amazon.com/images/I/711NuU+tsvL.jpg", bgColor: "from-amber-600 to-amber-800" }
        ];

        let allMedicines = [];
        let currentPrice = 0;
        let discountInfo = { applied: false, code: '', percent: 0 };
        let trendingInterval;

        const searchBar = document.getElementById('search-bar');
        const medicineSelect = document.getElementById('medicine-select');
        const medicineGrid = document.getElementById('medicine-grid');
        const noResultsMsg = document.getElementById('no-results');
        const initialPrompt = document.getElementById('initial-prompt');
        const shimmerContainer = document.getElementById('shimmer-container');
        const promoModal = document.getElementById('promo-modal');
        const spinWinModal = document.getElementById('spin-win-modal');
        const authModal = document.getElementById('auth-modal');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const placeOrderBtn = document.getElementById('place-order-btn');


        function createShimmerCards() {
            shimmerContainer.innerHTML = '';
            initialPrompt.classList.add('hidden');
            const banners = document.createElement('div');
            banners.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-8';
            banners.innerHTML = `<div class="shimmer-bg h-48 rounded-xl"></div><div class="shimmer-bg h-48 rounded-xl"></div>`;
            shimmerContainer.appendChild(banners);
            const shimmerGrid = document.createElement('div');
            shimmerGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
            for(let i = 0; i < 8; i++) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl overflow-hidden';
                card.innerHTML = `<div class="shimmer-bg w-full h-48"></div><div class="p-4"><div class="shimmer-bg h-6 w-3/4 rounded mb-2"></div><div class="shimmer-bg h-8 w-1/2 rounded"></div></div>`;
                shimmerGrid.appendChild(card);
            }
            shimmerContainer.appendChild(shimmerGrid);
        }

        async function loadMedicinesFromSheet() {
            if (GOOGLE_SHEET_URL === 'YOUR_GOOGLE_SHEET_PUBLISHED_CSV_URL_HERE') {
                shimmerContainer.classList.add('hidden');
                initialPrompt.innerHTML = '<div class="text-center"><i class="fa-solid fa-triangle-exclamation fa-3x mb-4 text-red-500"></i><p>Website not configured.</p></div>';
                initialPrompt.classList.remove('hidden');
                return;
            }
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) throw new Error('Network response not ok.');
                const csvText = await response.text();
                
                const rows = csvText.split(/\r?\n/).slice(1);
                allMedicines = rows.map(row => {
                    const columns = row.split(',');
                    return { name: columns[0] ? columns[0].trim() : '', price: columns[1] ? columns[1].trim() : '', image: columns[2] ? columns[2].trim() : '' };
                }).filter(med => med.name);

                shimmerContainer.classList.add('hidden');
                initialPrompt.classList.remove('hidden');
                populateMedicineSelect();
                startTrendingAnimation();
                
                if (!sessionStorage.getItem('promoShown')) {
                    setTimeout(() => {
                        promoModal.classList.remove('hidden');
                        promoModal.classList.add('modal-enter-active');
                        sessionStorage.setItem('promoShown', 'true');
                    }, 3000);
                }

            } catch (error) {
                console.error('Error fetching or parsing sheet data:', error);
                shimmerContainer.classList.add('hidden');
                initialPrompt.innerHTML = '<div class="text-center"><i class="fa-solid fa-circle-exclamation fa-3x mb-4 text-red-500"></i><p>Could not load product inventory.<br>Please check the Google Sheet URL.</p></div>';
                initialPrompt.classList.remove('hidden');
            }
        }
        
        function renderMedicineCards(medsToDisplay) {
            medicineGrid.innerHTML = ''; 
            medsToDisplay.forEach(med => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl text-center card-hover-effect overflow-hidden flex flex-col';
                card.innerHTML = `<img src="${med.image}" alt="${med.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x300/cccccc/ffffff?text=Image+Not+Found';"><div class="p-4 flex flex-col flex-grow"><p class="font-bold text-md text-gray-800 flex-grow">${med.name}</p><p class="font-semibold text-lg text-gray-700 mt-2">${med.price}</p></div><button class="select-btn w-full bg-teal-50 text-teal-700 font-bold py-3 hover:bg-teal-100 transition" data-name="${med.name}">Select</button>`;
                medicineGrid.appendChild(card);
            });
            document.querySelectorAll('.select-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const medName = e.target.dataset.name;
                medicineSelect.value = medName;
                updatePriceDetails();
                document.getElementById('booking-section').scrollIntoView();
            }));
        }

        function filterAndRender() {
            const query = searchBar.value.toLowerCase().trim();
            initialPrompt.classList.add('hidden');
            if (query.length === 0) {
                medicineGrid.classList.add('hidden');
                noResultsMsg.classList.add('hidden');
                if (allMedicines.length > 0) initialPrompt.classList.remove('hidden');
                return;
            }
            const filteredMeds = allMedicines.filter(med => med.name.toLowerCase().includes(query));
            if (filteredMeds.length > 0) {
                medicineGrid.classList.remove('hidden');
                noResultsMsg.classList.add('hidden');
                renderMedicineCards(filteredMeds);
            } else {
                medicineGrid.classList.add('hidden');
                noResultsMsg.classList.remove('hidden');
            }
        }

        function updatePriceDetails() {
            const selectedMedName = medicineSelect.value;
            const selectedMed = allMedicines.find(m => m.name === selectedMedName);
            const priceSection = document.getElementById('price-section');

            if (!selectedMed || !selectedMed.price) {
                priceSection.classList.add('hidden');
                return;
            }
            
            priceSection.classList.remove('hidden');
            const priceText = selectedMed.price.replace(/[^\d.-]/g, '');
            currentPrice = parseFloat(priceText);
            
            discountInfo = { applied: false, code: '', percent: 0 };
            document.getElementById('coupon-input').value = '';
            document.getElementById('coupon-status').textContent = '';
            document.getElementById('discount-row').classList.add('hidden');
            
            updateDisplayAndHiddenInputs();
        }
        
        function updateDisplayAndHiddenInputs() {
            let discountAmount = 0;
            if (discountInfo.applied) {
                discountAmount = currentPrice * (discountInfo.percent / 100);
                document.getElementById('discount-row').classList.remove('hidden');
                document.getElementById('discount-display').textContent = `- ₹${discountAmount.toFixed(2)} (${discountInfo.percent}%)`;
            } else {
                   document.getElementById('discount-row').classList.add('hidden');
            }
            const finalPrice = currentPrice - discountAmount;

            document.getElementById('price-display').textContent = `₹${currentPrice.toFixed(2)}`;
            document.getElementById('total-display').textContent = `₹${finalPrice.toFixed(2)}`;
            
            document.getElementById('hidden-original-price').value = `₹${currentPrice.toFixed(2)}`;
            document.getElementById('hidden-discount-applied').value = discountInfo.applied ? `Yes (${discountInfo.code} - ${discountInfo.percent}%)` : 'No';
            document.getElementById('hidden-final-price').value = `₹${finalPrice.toFixed(2)}`;
            
            // Enable/disable place order button based on location status
            updatePlaceOrderButtonStatus();
        }

        function applyCoupon() {
            const couponInput = document.getElementById('coupon-input');
            const couponStatus = document.getElementById('coupon-status');
            const code = couponInput.value.trim().toUpperCase();
            
            const validCoupons = {
                'LUCKY15': 15,
                'SPIN5': 5,
                'SPIN10': 10,
                'SPIN20': 20
            };

            if (validCoupons[code]) {
                discountInfo = { applied: true, code: code, percent: validCoupons[code] };
                couponStatus.textContent = `Coupon "${code}" applied successfully!`;
                couponStatus.className = 'text-sm mt-1 text-green-600';
            } else {
                discountInfo = { applied: false, code: '', percent: 0 };
                couponStatus.textContent = 'Invalid coupon code.';
                couponStatus.className = 'text-sm mt-1 text-red-600';
            }
            updateDisplayAndHiddenInputs();
        }

        function populateScrollingBanners() {
            const scrollingBannersContainer = document.getElementById('scrolling-banners');
            scrollingBannersContainer.innerHTML = '';
            const bannerItems = [...featuredProducts, ...featuredProducts];
            bannerItems.forEach(product => {
                const banner = document.createElement('div');
                banner.className = `flex-shrink-0 w-1/2 md:w-1/4 p-3`;
                banner.innerHTML = `<div class="banner-card bg-gradient-to-br ${product.bgColor} rounded-xl p-6 text-white cursor-pointer relative overflow-hidden flex flex-col justify-end h-48"><img src="${product.image}" class="absolute top-0 left-0 w-full h-full object-contain" alt="" onerror="this.style.display='none'"><div class="absolute inset-0 bg-black/30"></div><span class="text-lg font-bold relative z-10 self-start bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">Shop Now</span></div>`;
                banner.addEventListener('click', () => {
                    searchBar.value = product.name;
                    filterAndRender();
                });
                scrollingBannersContainer.appendChild(banner);
            });
        }
        
        function startTrendingAnimation() {
            const trendingTextElement = document.getElementById('trending-text');
            if (trendingInterval) clearInterval(trendingInterval);
            if(allMedicines.length === 0) {
                trendingTextElement.textContent = "No products found.";
                return;
            };
            let currentIndex = 0;
            trendingTextElement.textContent = allMedicines[currentIndex].name;
            trendingInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % allMedicines.length;
                trendingTextElement.style.animation = 'none';
                void trendingTextElement.offsetWidth;
                trendingTextElement.style.animation = null; 
                trendingTextElement.textContent = allMedicines[currentIndex].name;
            }, 3000);
        }

        function populateMedicineSelect() {
            medicineSelect.innerHTML = '<option value="">-- Search and select a product --</option>';
            allMedicines.forEach(med => {
                const option = document.createElement('option');
                option.value = med.name;
                option.textContent = `${med.name} (${med.price})`;
                medicineSelect.appendChild(option);
            });
            medicineSelect.disabled = false;
        }

        function showModal(title, message, iconHTML = '') {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalIcon = document.getElementById('modal-icon');
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.innerHTML = iconHTML;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => { modal.classList.add('modal-enter-active'); });
        }
        
        async function handleBookingSubmit(e) {
            e.preventDefault();
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                showModal("Login Required", "Please log in or create an account to place an order.", '<i class="fa-solid fa-user-lock text-yellow-500 fa-3x"></i>');
                openAuthModal();
                return;
            }

            if (!isLocationAccepted) {
                showModal("Location Required", "Please allow and confirm your location to place an order. Service is only available within 2 kilometers of the store.", '<i class="fa-solid fa-map-marker-alt text-red-500 fa-3x"></i>');
                return;
            }

            const form = e.target;
            const data = new FormData(form);
            if (!data.get('Medicine') || !data.get('Customer Name') || !data.get('Delivery Address') || !data.get('WhatsApp Number')) {
                showModal("Missing Information", "Please fill out all required fields, including your WhatsApp number.", '<i class="fa-solid fa-circle-exclamation text-yellow-500 fa-3x"></i>'); return;
            }
            try {
                const response = await fetch(form.action, { method: form.method, body: data, headers: { 'Accept': 'application/json' }});
                if (response.ok) {
                    showModal("Order Placed Successfully!", "Thank you for your order. We have received it and will contact you on WhatsApp shortly.", '<i class="fa-solid fa-circle-check text-green-500 fa-3x"></i>');
                    form.reset();
                    document.getElementById('location-coords').value = ""; // Clear GPS location after order
                    locationStatus.textContent = "Location must be provided to place an order."; // Reset status message
                    locationStatus.className = "text-sm text-center mt-2 text-gray-500";
                    isLocationAccepted = false; // Reset location flag
                    updatePlaceOrderButtonStatus(); // Update button status
                    document.getElementById('price-section').classList.add('hidden');
                    updateAuthUI(); // Refill name if logged in
                } else {
                    showModal("Submission Error", "Could not send order. Please try again later.", '<i class="fa-solid fa-circle-exclamation text-red-500 fa-3x"></i>');
                }
            } catch (error) {
                showModal("Network Error", "Could not send order. Please check your internet connection.", '<i class="fa-solid fa-wifi text-red-500 fa-3x"></i>');
            }
        }
        
        // --- UPDATED SPIN & WIN LOGIC ---
        function handleSpinWin() {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!loggedInUser || !loggedInUser.email) { // Ensure user is logged in and has an email
                openAuthModal();
                return;
            }

            const spinBtn = document.getElementById('spin-btn');
            const spinResult = document.getElementById('spin-result');
            const spinWheel = document.getElementById('spin-wheel');

            // Initial check: Make an API call to Apps Script to check cooldown
            spinResult.textContent = 'Checking spin eligibility...';
            spinBtn.disabled = true; // Disable while checking

            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 spinResult.textContent = 'Error: Apps Script URL not configured.';
                 return;
            }

            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'spin',
                    userEmail: loggedInUser.email // Send the user's email
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // User is allowed to spin, now show the modal
                    spinWinModal.classList.remove('hidden');
                    spinWinModal.classList.add('modal-enter-active');
                    spinResult.textContent = 'Ready to spin!';
                    spinBtn.disabled = false; // Enable for the actual spin
                    
                    // Set up spin button for actual spin logic (this replaces the previous global listener)
                    spinBtn.onclick = () => {
                        spinBtn.disabled = true; // Disable during spin animation
                        spinResult.textContent = 'Spinning...';
                        
                        const segments = [
                            { text: '5% OFF', code: 'SPIN5', percent: 5 },
                            { text: 'Try Again', code: 'LOSE' },
                            { text: '10% OFF', code: 'SPIN10', percent: 10 },
                            { text: 'Try Again', code: 'LOSE' },
                            { text: '20% OFF', code: 'SPIN20', percent: 20 },
                            { text: 'Try Again', code: 'LOSE' }
                        ];

                        // Find the index of the prize returned by the backend to align animation
                        let targetSegmentIndex = segments.findIndex(s => s.code === result.prize.code);
                        if (targetSegmentIndex === -1) targetSegmentIndex = 0; // Fallback in case prize code not found

                        const segmentAngle = 360 / segments.length;
                        // Calculate rotation to land on the *center* of the target segment
                        // A full 5-6 spins plus the exact angle to the target segment center
                        const totalRotation = (5 * 360) + (360 - (targetSegmentIndex * segmentAngle + segmentAngle / 2));
                        
                        spinWheel.style.transition = 'transform 5s cubic-bezier(0.25, 1, 0.5, 1)'; // Smooth ease-out transition
                        spinWheel.style.transform = `rotate(${totalRotation}deg)`;

                        setTimeout(() => {
                            if (result.prize.code !== 'LOSE') {
                                spinResult.innerHTML = `🎉 You won! Your coupon is: <strong class="bg-yellow-200 text-yellow-800 px-2 rounded">${result.prize.code}</strong>`;
                            } else {
                                spinResult.textContent = 'Better luck next time!';
                            }
                            // Reset the rotation for the next spin (optional, for visual consistency)
                            setTimeout(() => {
                                spinWheel.style.transition = 'none'; // Remove transition to instantly snap back
                                spinWheel.style.transform = 'rotate(0deg)'; // Reset for next spin
                                // spinBtn.disabled = true; // Button disabled permanently until modal re-opened and re-checked
                            }, 1000); // Small delay after result shown
                        }, 5000); // This timeout should match the CSS transition duration
                    };

                } else {
                    // User is NOT allowed to spin (cooldown active or other error)
                    spinBtn.disabled = true; // Keep disabled
                    spinResult.textContent = result.message; // Show cooldown message
                    spinWinModal.classList.remove('hidden');
                    spinWinModal.classList.add('modal-enter-active');
                }
            })
            .catch(error => {
                console.error('Error checking spin eligibility or fetching spin result:', error);
                spinResult.textContent = 'Error checking spin. Please try again.';
                spinBtn.disabled = false; // Allow retrying the check if it was a network error
            });
        }

        function createSpinWheel() {
            const wheel = document.getElementById('spin-wheel');
            const segments = [
                { text: '5%', icon: 'fa-gift', color: '#a7f3d0' },
                { text: 'Sorry', icon: 'fa-face-sad-tear', color: '#e5e7eb' },
                { text: '10%', icon: 'fa-gift', color: '#a5f3fc' },
                { text: 'Sorry', icon: 'fa-face-sad-tear', color: '#e5e7eb' },
                { text: '20%', icon: 'fa-star', color: '#6ee7b7' },
                { text: 'Sorry', icon: 'fa-face-sad-tear', color: '#e5e7eb' }
            ];
            const segmentAngle = 360 / segments.length;
            wheel.innerHTML = '';
            wheel.style.background = `conic-gradient(${
                segments.map((seg, i) => `${seg.color} ${i * segmentAngle}deg ${(i+1) * segmentAngle}deg`).join(', ')
            })`;
            
            segments.forEach((seg, i) => {
                const textDiv = document.createElement('div');
                textDiv.className = 'absolute w-full h-full';
                textDiv.style.transform = `rotate(${i * segmentAngle + segmentAngle / 2}deg)`;
                textDiv.innerHTML = `<span class="absolute top-6 left-1/2 -translate-x-1/2 font-bold text-gray-700 flex flex-col items-center gap-1"><i class="fa-solid ${seg.icon}"></i> ${seg.text}</span>`;
                wheel.appendChild(textDiv);
            });
        }
        
        // The previous spin-btn event listener is now handled by the `onclick` inside `handleSpinWin`


        function updateAuthUI() {
            const authDesktop = document.getElementById('auth-buttons-desktop');
            const authMobile = document.getElementById('auth-buttons-mobile');
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

            let desktopHTML = '';
            let mobileHTML = '';

            if (loggedInUser) {
                desktopHTML = `<div class="flex items-center gap-4"><span class="font-semibold text-gray-700">Hi, ${loggedInUser.name}</span><button id="logout-btn-desktop" class="text-gray-600 hover:text-teal-600 font-medium">Logout</button></div>`;
                mobileHTML = `<div class="py-3 px-4 text-gray-800 font-semibold">Hi, ${loggedInUser.name}</div><button id="logout-btn-mobile" class="w-full text-left block py-3 px-4 text-red-600 hover:bg-red-50">Logout</button>`;
                document.getElementById('name').value = loggedInUser.name;
            } else {
                desktopHTML = `<button id="login-signup-btn-desktop" class="bg-teal-600 text-white font-bold py-2 px-5 rounded-full hover:bg-teal-700 transition btn-glow">Login / Sign Up</button>`;
                mobileHTML = `<button id="login-signup-btn-mobile" class="w-full text-left bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Login / Sign Up</button>`;
                document.getElementById('name').value = '';
            }

            authDesktop.innerHTML = desktopHTML;
            authMobile.innerHTML = mobileHTML;

            // Re-attach event listeners as innerHTML overwrites them
            if (loggedInUser) {
                document.getElementById('logout-btn-desktop').addEventListener('click', handleLogout);
                document.getElementById('logout-btn-mobile').addEventListener('click', handleLogout);
            } else {
                document.getElementById('login-signup-btn-desktop').addEventListener('click', openAuthModal);
                document.getElementById('login-signup-btn-mobile').addEventListener('click', openAuthModal);
            }
        }

        function openAuthModal() {
            authModal.classList.remove('hidden');
            authModal.classList.add('modal-enter-active');
            // Ensure login form is shown by default when opening modal
            document.getElementById('login-tab-btn').click();
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            updateAuthUI();
            showModal("Logged Out", "You have been logged out.", '<i class="fa-solid fa-circle-info text-blue-500 fa-3x"></i>');
        }

        async function handleSignUp(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');

            errorEl.textContent = ''; // Clear previous errors

            if (!name || !email || !password) {
                errorEl.textContent = 'All fields are required.';
                return;
            }

            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 errorEl.textContent = 'Please configure your Google Apps Script Web App URL in script.js.';
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'signup',
                        name: name,
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Hide signup form, show OTP verification
                    document.getElementById('signup-form').classList.add('hidden');
                    document.getElementById('otp-verification-section').classList.remove('hidden');
                    document.getElementById('otp-email').value = email; // Pre-fill OTP email
                    showModal("Registration Successful!", result.message, '<i class="fa-solid fa-check-circle text-green-500 fa-3x"></i>');
                    errorEl.textContent = ''; // Clear signup error on success
                } else {
                    errorEl.textContent = result.message;
                }
            } catch (error) {
                console.error('Signup error:', error);
                errorEl.textContent = 'Network error or server unavailable. Please try again.';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            errorEl.textContent = ''; // Clear previous errors

            if (!email || !password) {
                errorEl.textContent = 'Email and password are required.';
                return;
            }
            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 errorEl.textContent = 'Please configure your Google Apps Script Web App URL in script.js.';
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'login',
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('loggedInUser', JSON.stringify({ name: result.name, email: result.email }));
                    errorEl.textContent = ''; // Clear any error
                    document.getElementById('auth-modal').classList.add('hidden');
                    updateAuthUI(); // Update navigation/UI
                    showModal("Login Successful!", `Welcome back, ${result.name}!`, '<i class="fa-solid fa-circle-check text-green-500 fa-3x"></i>');
                } else {
                    errorEl.textContent = result.message;
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Network error or server unavailable. Please try again.';
            }
        }

        async function handleVerifyOtp() {
            const email = document.getElementById('otp-email').value;
            const otp = document.getElementById('otp-input').value;
            const errorEl = document.getElementById('otp-error');

            errorEl.textContent = ''; // Clear previous errors

            if (!email || !otp) {
                errorEl.textContent = 'Email and OTP are required.';
                return;
            }
            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 errorEl.textContent = 'Please configure your Google Apps Script Web App URL in script.js.';
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'verifyOtp',
                        email: email,
                        otp: otp
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show the success modal first
                    showModal("Verification Successful!", result.message + "\nYou can now log in.", '<i class="fa-solid fa-check-circle text-green-500 fa-3x"></i>');
                    
                    // Add a short delay (e.g., 2 seconds) before changing the forms and closing the modal
                    setTimeout(() => {
                        document.getElementById('otp-verification-section').classList.add('hidden');
                        document.getElementById('login-form').classList.remove('hidden'); // Show login form
                        document.getElementById('otp-input').value = ''; // Clear OTP
                        document.getElementById('otp-email').value = ''; // Clear OTP email
                        document.getElementById('login-email').value = email; // Pre-fill login email
                        errorEl.textContent = ''; // Clear OTP error on success
                        
                        // Explicitly hide the modal after the delay, so it doesn't linger
                        document.getElementById('modal').classList.add('hidden'); 

                    }, 2000); // 2000 milliseconds = 2 seconds. Adjust as needed.
                    
                } else {
                    errorEl.textContent = result.message;
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                errorEl.textContent = 'Network error or server unavailable. Please try again.';
            }
        }

        async function handleResendOtp() {
            const email = document.getElementById('otp-email').value;
            const errorEl = document.getElementById('otp-error');
            errorEl.textContent = ''; // Clear any previous error

            if (!email) {
                errorEl.textContent = 'Email is required to resend OTP.';
                return;
            }
            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 errorEl.textContent = 'Please configure your Google Apps Script Web App URL in script.js.';
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'sendOtp',
                        email: email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    errorEl.textContent = result.message;
                    errorEl.style.color = 'green';
                } else {
                    errorEl.textContent = result.message;
                    errorEl.style.color = 'red';
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                errorEl.textContent = 'Network error or server unavailable. Please try again.';
            }
        }

        async function handleForgotPassword() {
            const emailInput = prompt("Please enter your registered email address:");
            if (!emailInput) return; // User cancelled prompt

            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 showModal("Configuration Error", "Please configure your Google Apps Script Web App URL in script.js.", '<i class="fa-solid fa-triangle-exclamation text-yellow-500 fa-3x"></i>');
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'forgotPassword',
                        email: emailInput
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showModal("Password Reset", result.message, '<i class="fa-solid fa-envelope text-blue-500 fa-3x"></i>');
                    // Important: The Apps Script will send a link.
                    // Make sure the link's domain matches where you host this HTML file.
                    // e.g., if this HTML is at "https://yourwebsite.com/index.html"
                    // then the Apps Script should send a link like "https://yourwebsite.com/index.html?email=...&token=..."
                } else {
                    showModal("Error", result.message, '<i class="fa-solid fa-circle-exclamation text-red-500 fa-3x"></i>');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                showModal("Network Error", "Could not send reset request. Please check your internet connection.", '<i class="fa-solid fa-wifi text-red-500 fa-3x"></i>');
            }
        }

        async function handleResetPasswordSubmit() {
            const email = document.getElementById('reset-email').value;
            const token = document.getElementById('reset-token-input').value;
            const newPassword = document.getElementById('new-password-input').value;
            const errorEl = document.getElementById('reset-password-error');

            errorEl.textContent = '';

            if (!email || !token || !newPassword) {
                errorEl.textContent = 'All fields are required.';
                return;
            }
            if (APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                 errorEl.textContent = 'Please configure your Google Apps Script Web App URL in script.js.';
                 return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'resetPassword',
                        email: email,
                        resetToken: token,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showModal("Password Reset Successful", result.message + "\nYou can now log in with your new password.", '<i class="fa-solid fa-check-circle text-green-500 fa-3x"></i>');
                    document.getElementById('reset-password-section').classList.add('hidden');
                    // After reset, show login form
                    document.getElementById('auth-modal').classList.remove('hidden');
                    document.getElementById('login-tab-btn').click(); // Switch to login tab
                    document.getElementById('login-email').value = email; // Pre-fill login email
                    errorEl.textContent = ''; // Clear reset error on success
                } else {
                    errorEl.textContent = result.message;
                }
            } catch (error) {
                console.error('Password reset error:', error);
                errorEl.textContent = 'Network error or server unavailable. Please try again.';
            }
        }

        // Function to check URL for reset parameters on page load
        function checkResetPasswordParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const token = urlParams.get('token');

            if (email && token) {
                // Show the reset password section and pre-fill fields
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('otp-verification-section').classList.add('hidden');
                document.getElementById('reset-password-section').classList.remove('hidden');

                document.getElementById('reset-email').value = email;
                document.getElementById('reset-token-input').value = token;
                // Clear the URL parameters after processing to prevent re-triggering on refresh
                history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // --- Haversine formula to calculate distance between two lat/lon points ---
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180; // φ, λ in radians
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // in metres
            return d;
        }

        function handleGetLocation() {
            if (!navigator.geolocation) {
                showModal("Feature Not Supported", "Geolocation is not supported by your browser.", '<i class="fa-solid fa-circle-exclamation text-red-500 fa-3x"></i>');
                locationStatus.textContent = "Geolocation not supported.";
                locationStatus.className = "text-sm text-center mt-2 text-red-500";
                isLocationAccepted = false;
                updatePlaceOrderButtonStatus();
                return;
            }
            locationStatus.textContent = "Fetching your location..."; // More user-friendly
            locationStatus.className = "text-sm text-center mt-2 text-blue-500";
            placeOrderBtn.disabled = true; // Disable while fetching location

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;
                    document.getElementById('location-coords').value = `${userLatitude},${userLongitude}`;

                    const distance = haversineDistance(STORE_LATITUDE, STORE_LONGITUDE, userLatitude, userLongitude);
                    
                    if (distance <= SERVICE_RADIUS_METERS) {
                        locationStatus.innerHTML = `<i class="fa-solid fa-check-circle text-green-600"></i> Location confirmed!`;
                        locationStatus.className = "text-sm text-center mt-2 text-green-600 font-semibold";
                        isLocationAccepted = true;
                    } else {
                        locationStatus.innerHTML = `
                            <div class="text-xl font-bold text-red-600 mb-1">
                                <i class="fa-solid fa-circle-xmark mr-2"></i> We're sorry!
                            </div>
                            <span class="text-lg md:text-xl font-semibold text-gray-700">Our delivery service is currently unavailable at your location.</span>
                            <p class="text-md text-gray-500 mt-2">We serve within ${SERVICE_RADIUS_METERS / 1000} km of our store.</p>
                        `;
                        locationStatus.className = "text-center mt-2"; // Remove previous class for more control with new HTML
                        isLocationAccepted = false;
                        document.getElementById('location-coords').value = ""; // Clear coordinates if out of range
                    }
                    updatePlaceOrderButtonStatus(); // Update button after location check
                },
                (error) => {
                    locationStatus.textContent = "Could not pinpoint your location. Please ensure location services are enabled for your browser.";
                    locationStatus.className = "text-sm text-center mt-2 text-red-500";
                    isLocationAccepted = false;
                    document.getElementById('location-coords').value = "";
                    updatePlaceOrderButtonStatus(); // Update button after location failure
                    console.error("Geolocation error:", error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function updatePlaceOrderButtonStatus() {
            // Button is enabled only if location is accepted (within range) AND a medicine is selected
            const isMedicineSelected = medicineSelect.value !== "";
            placeOrderBtn.disabled = !(isLocationAccepted && isMedicineSelected);
            if (!isLocationAccepted) {
                placeOrderBtn.textContent = 'Please Get Your Location to Order';
            } else if (!isMedicineSelected) {
                placeOrderBtn.textContent = 'Select a Medicine to Order';
            } else {
                placeOrderBtn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> Confirm & Place Order';
            }
        }


        // --- Event Listeners & Initialization ---
        document.getElementById('hamburger-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
        document.querySelectorAll('#mobile-menu a, #promo-shop-now').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.add('hidden');
                promoModal.classList.add('hidden');
            });
        });
        
        searchBar.addEventListener('input', filterAndRender);
        medicineSelect.addEventListener('change', updatePriceDetails);
        document.getElementById('show-coupon-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('coupon-section').classList.toggle('hidden');
        });
        document.getElementById('apply-coupon-btn').addEventListener('click', applyCoupon);
        
        // Location button listener (now required)
        getLocationBtn.addEventListener('click', handleGetLocation); 
        
        document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
        document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal').classList.add('hidden'));
        document.getElementById('promo-close-btn').addEventListener('click', () => promoModal.classList.add('hidden'));
        
        // Spin & Win button listeners (now call handleSpinWin)
        document.getElementById('spin-win-nav-btn').addEventListener('click', handleSpinWin);
        document.getElementById('spin-win-mobile-btn').addEventListener('click', handleSpinWin);
        document.getElementById('spin-win-close-btn').addEventListener('click', () => spinWinModal.classList.add('hidden'));
        
        document.getElementById('auth-close-btn').addEventListener('click', () => authModal.classList.add('hidden'));
        
        // --- Authentication Tabs Management ---
        document.getElementById('login-tab-btn').addEventListener('click', () => {
            document.getElementById('login-tab-btn').classList.add('text-teal-600', 'border-teal-600');
            document.getElementById('signup-tab-btn').classList.remove('text-teal-600', 'border-teal-600');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('otp-verification-section').classList.add('hidden'); // Hide OTP section
            document.getElementById('reset-password-section').classList.add('hidden'); // Hide Reset section
            document.getElementById('login-error').textContent = ''; // Clear errors
        });
        document.getElementById('signup-tab-btn').addEventListener('click', () => {
            document.getElementById('signup-tab-btn').classList.add('text-teal-600', 'border-teal-600');
            document.getElementById('login-tab-btn').classList.remove('text-teal-600', 'border-teal-600');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('otp-verification-section').classList.add('hidden'); // Hide OTP section
            document.getElementById('reset-password-section').classList.add('hidden'); // Hide Reset section
            document.getElementById('signup-error').textContent = ''; // Clear errors
        });

        // --- Auth Form Submissions ---
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('signup-form').addEventListener('submit', handleSignUp);
        
        // --- OTP and Forgot Password Listeners ---
        document.getElementById('verify-otp-btn').addEventListener('click', handleVerifyOtp);
        document.getElementById('resend-otp-btn').addEventListener('click', handleResendOtp);
        document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
        document.getElementById('submit-reset-password-btn').addEventListener('click', handleResetPasswordSubmit); // For the reset password form

        document.getElementById('hero-order-now-btn').addEventListener('click', () => {
             if (localStorage.getItem('loggedInUser')) {
                 document.getElementById('booking-section').scrollIntoView();
             } else {
                 openAuthModal();
             }
        });
        
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // --- Initial Page Load Functions ---
        createShimmerCards();
        loadMedicinesFromSheet();
        populateScrollingBanners();
        createSpinWheel();
        updateAuthUI(); // Sets up login/logout buttons
        updatePlaceOrderButtonStatus(); // Initial check for place order button status
        
        // Trigger location request on page load or after a short delay
        setTimeout(handleGetLocation, 1000); 

        // Check for password reset parameters on page load
        checkResetPasswordParams();
    });
    </script>
</body>
</html>
